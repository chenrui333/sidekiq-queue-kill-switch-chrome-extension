# Release workflow for Sidekiq Queue Kill Switch Chrome Extension
#
# Triggered on version tags (v*.*.*). Validates manifest version matches tag,
# builds the extension ZIP, and creates a GitHub Release with the asset attached.
#
# Uses softprops/action-gh-release for release creation because:
# - Single action handles release creation + asset upload
# - Native support for generate_release_notes
# - Well-maintained and widely used
# - Simpler than gh CLI for asset attachment

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

# Minimal permissions - only what's needed for release creation
permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: Extract version from tag
        id: version
        run: |
          # Strip 'v' prefix from tag to get semantic version
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION from tag: $TAG"

      - name: Validate manifest version matches tag
        run: |
          python3 scripts/validate-version.py "${{ steps.version.outputs.version }}"

      - name: Build extension package
        run: make package

      - name: Verify ZIP was created
        run: |
          if [ ! -f "dist/sidekiq-queue-kill-switch.zip" ]; then
            echo "::error::ZIP file not found at dist/sidekiq-queue-kill-switch.zip"
            exit 1
          fi
          echo "ZIP created successfully:"
          ls -la dist/
          unzip -l dist/sidekiq-queue-kill-switch.zip

      - name: Upload build artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: sidekiq-queue-kill-switch-${{ steps.version.outputs.tag }}
          path: dist/sidekiq-queue-kill-switch.zip
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: dist/sidekiq-queue-kill-switch.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
